name: Publish

# Manual only. Can only be triggered from the main branch — enforced at runtime
# in the `guard` job below (GitHub Actions has no native branch filter for
# workflow_dispatch).
#
# Flow: guard → ci → bump → build (TUI only) → github-release → publish
#
# Version source of truth: Cargo.toml (not git tags).
# The bump commit SHA is threaded through jobs so every downstream step checks
# out the exact commit that was versioned, avoiding --allow-dirty.
#
# To add ratatoist-nvim when it's ready for crates.io:
#   1. Add it to the `crate` options list below.
#   2. No other changes needed — the conditional `if: inputs.crate == 'ratatoist-tui'`
#      gates binary builds automatically.

on:
  workflow_dispatch:
    inputs:
      crate:
        description: "Crate to publish"
        required: true
        type: choice
        options:
          - ratatoist-core
          - ratatoist-tui
      bump:
        description: "Version bump"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ── 1. Branch guard ────────────────────────────────────────────────────────
  guard:
    name: Enforce main branch
    runs-on: ubuntu-latest
    steps:
      - name: Fail if not triggered from main
        run: |
          if [ "${{ github.ref }}" != "refs/heads/main" ]; then
            echo "::error::This workflow must be triggered from the main branch (got: ${{ github.ref }})"
            exit 1
          fi

  # ── 2. CI (reused from ci.yml) ─────────────────────────────────────────────
  ci:
    name: CI
    needs: guard
    uses: ./.github/workflows/ci.yml

  # ── 3. Version bump ────────────────────────────────────────────────────────
  bump:
    name: Bump ${{ inputs.crate }} (${{ inputs.bump }})
    needs: ci
    runs-on: ubuntu-latest
    outputs:
      version:      ${{ steps.semver.outputs.version }}
      prev_version: ${{ steps.semver.outputs.prev_version }}
      sha:          ${{ steps.commit.outputs.sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate next version
        id: semver
        run: |
          TOML="crates/${{ inputs.crate }}/Cargo.toml"
          CURRENT=$(grep -oP '^version\s*=\s*"\K[^"]+' "$TOML" | head -1)
          IFS='.' read -r MAJ MIN PAT <<< "$CURRENT"

          case "${{ inputs.bump }}" in
            major) MAJ=$((MAJ + 1)); MIN=0; PAT=0 ;;
            minor) MIN=$((MIN + 1)); PAT=0 ;;
            patch) PAT=$((PAT + 1)) ;;
          esac

          if [ -z "$CURRENT" ]; then
            echo "::error::Could not read current version from $TOML — check the file format"
            exit 1
          fi

          NEXT="$MAJ.$MIN.$PAT"
          echo "version=$NEXT"        >> $GITHUB_OUTPUT
          echo "prev_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "${{ inputs.crate }}: $CURRENT → $NEXT"

      - name: Update Cargo.toml versions
        run: |
          VERSION="${{ steps.semver.outputs.version }}"

          # 1. Bump the crate's own version.
          sed -i -E "s/^version\s*=\s*\"[^\"]+\"/version = \"$VERSION\"/" "crates/${{ inputs.crate }}/Cargo.toml"

          # 2. When bumping core, also update the workspace-level version declaration
          #    in the root Cargo.toml.  All consumers inherit it via `workspace = true`
          #    — no per-crate file needs touching.
          if [ "${{ inputs.crate }}" = "ratatoist-core" ]; then
            sed -i "s|ratatoist-core = { path = \"crates/ratatoist-core\", version = \"[^\"]*\" }|ratatoist-core = { path = \"crates/ratatoist-core\", version = \"$VERSION\" }|" Cargo.toml
            echo "Updated workspace dep: ratatoist-core → $VERSION"
          fi

      - name: Commit and push
        id: commit
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: ${{ inputs.crate }} v${{ steps.semver.outputs.version }}"
          git push origin main
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

  # ── 4. Cross-compile binaries (ratatoist-tui only) ─────────────────────────
  build:
    name: Build ${{ matrix.target }}
    needs: bump
    if: inputs.crate == 'ratatoist-tui'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { target: aarch64-apple-darwin,     os: macos-latest   }
          - { target: x86_64-apple-darwin,      os: macos-latest   }
          - { target: x86_64-unknown-linux-gnu,  os: ubuntu-latest  }
          - { target: aarch64-unknown-linux-gnu, os: ubuntu-latest  }
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump.outputs.sha }}

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}

      - name: Build
        run: cargo build --release --target ${{ matrix.target }} -p ratatoist-tui

      - name: Package
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../ratatoist-${{ matrix.target }}.tar.gz ratatoist
          cd ../../..
          shasum -a 256 ratatoist-${{ matrix.target }}.tar.gz \
            > ratatoist-${{ matrix.target }}.tar.gz.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: ratatoist-${{ matrix.target }}
          path: |
            ratatoist-${{ matrix.target }}.tar.gz
            ratatoist-${{ matrix.target }}.tar.gz.sha256

  # ── 5. GitHub Release ───────────────────────────────────────────────────────
  # Tag is auto-created by GitHub from tag_name — no explicit git tag push needed.
  # TUI: attaches cross-compiled binaries. Core: release notes only.
  github-release:
    name: GitHub Release
    needs: [bump, build]
    if: |
      always() &&
      needs.bump.result == 'success' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        if: inputs.crate == 'ratatoist-tui'
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create release (TUI — with binaries)
        if: inputs.crate == 'ratatoist-tui'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.crate }}-v${{ needs.bump.outputs.version }}
          name: "${{ inputs.crate }} v${{ needs.bump.outputs.version }}"
          generate_release_notes: true
          files: artifacts/*

      - name: Create release (library — notes only)
        if: inputs.crate != 'ratatoist-tui'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.crate }}-v${{ needs.bump.outputs.version }}
          name: "${{ inputs.crate }} v${{ needs.bump.outputs.version }}"
          generate_release_notes: true

  # ── 6. Publish to crates.io ────────────────────────────────────────────────
  publish:
    name: Publish to crates.io
    needs: [bump, github-release]
    if: |
      always() &&
      needs.bump.result == 'success' &&
      needs.github-release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump.outputs.sha }}

      - uses: dtolnay/rust-toolchain@stable

      # For ratatoist-tui: verify that the version of ratatoist-core it depends on
      # is already live on crates.io before attempting to publish.  cargo publish
      # will try to resolve all non-path deps from the registry — if core isn't
      # there yet the publish fails after the version bump commit has already landed.
      - name: Check core is published (TUI only)
        if: inputs.crate == 'ratatoist-tui'
        run: |
          CORE_VERSION=$(grep 'ratatoist-core = { path' Cargo.toml | sed 's/.*version = "//;s/".*//')
          echo "Checking crates.io for ratatoist-core v$CORE_VERSION …"
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "User-Agent: ratatoist-publish-workflow" \
            "https://crates.io/api/v1/crates/ratatoist-core/$CORE_VERSION")
          if [ "$HTTP" != "200" ]; then
            echo "::error::ratatoist-core v$CORE_VERSION is not yet on crates.io (HTTP $HTTP)."
            echo "::error::Publish ratatoist-core first, then re-run this workflow for ratatoist-tui."
            exit 1
          fi
          echo "ratatoist-core v$CORE_VERSION confirmed on crates.io ✓"

      - name: Publish
        run: cargo publish -p ${{ inputs.crate }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Summary
        run: |
          echo "## Published ${{ inputs.crate }} v${{ needs.bump.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo ""                                                                      >> $GITHUB_STEP_SUMMARY
          echo "| | |"                                                                 >> $GITHUB_STEP_SUMMARY
          echo "|---|---|"                                                             >> $GITHUB_STEP_SUMMARY
          echo "| Previous version | \`${{ needs.bump.outputs.prev_version }}\` |"   >> $GITHUB_STEP_SUMMARY
          echo "| New version      | \`${{ needs.bump.outputs.version }}\` |"        >> $GITHUB_STEP_SUMMARY
          echo "| crates.io        | https://crates.io/crates/${{ inputs.crate }}/${{ needs.bump.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo ""                                                                      >> $GITHUB_STEP_SUMMARY
          echo "> To rollback: run **Rollback** with crate \`${{ inputs.crate }}\` and version \`${{ needs.bump.outputs.version }}\`." >> $GITHUB_STEP_SUMMARY

  # ── 7. Cleanup on failure ───────────────────────────────────────────────────
  # Runs only when something after the bump commit fails (CI, build, release,
  # or publish).  Deletes the GitHub Release and its auto-created tag so the
  # repo doesn't accumulate orphaned releases.
  #
  # Note: the version bump commit on main is NOT reverted automatically — it
  # stays so the next publish run correctly increments from the new version.
  # If you need to undo the bump itself, revert the commit manually and re-run.
  cleanup-on-failure:
    name: Cleanup on failure
    needs: [bump, ci, github-release, publish]
    if: |
      failure() &&
      needs.bump.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Delete GitHub Release and tag
        run: |
          TAG="${{ inputs.crate }}-v${{ needs.bump.outputs.version }}"
          if gh release view "$TAG" &>/dev/null; then
            gh release delete "$TAG" --yes --cleanup-tag
            echo "Deleted release and tag: $TAG"
          else
            echo "No release found for $TAG — nothing to clean up"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Publish failed — partial cleanup done" >> $GITHUB_STEP_SUMMARY
          echo ""                                         >> $GITHUB_STEP_SUMMARY
          echo "| | |"                                    >> $GITHUB_STEP_SUMMARY
          echo "|---|---|"                                >> $GITHUB_STEP_SUMMARY
          echo "| Crate   | \`${{ inputs.crate }}\` |"  >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.bump.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Release | deleted ✓ |"          >> $GITHUB_STEP_SUMMARY
          echo ""                                         >> $GITHUB_STEP_SUMMARY
          echo "> The version bump commit on \`main\` was **not** reverted." >> $GITHUB_STEP_SUMMARY
          echo "> Fix the issue and re-run **Publish** — it will attempt the same version again." >> $GITHUB_STEP_SUMMARY
