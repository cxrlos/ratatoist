name: Version Bump

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  bump:
    name: Bump version and tag
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      bumped: ${{ steps.bump.outputs.type != 'none' }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine bump type from PR labels
        id: bump
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          if echo "$LABELS" | grep -q '"major"'; then
            echo "type=major" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q '"minor"'; then
            echo "type=minor" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q '"patch"'; then
            echo "type=patch" >> $GITHUB_OUTPUT
          else
            echo "type=none" >> $GITHUB_OUTPUT
            echo "No version label found, skipping bump."
          fi

      - name: Calculate next version
        if: steps.bump.outputs.type != 'none'
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          CURRENT="${LATEST_TAG#v}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}

          case "${{ steps.bump.outputs.type }}" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          # Default to v0.1.0 if this would be v0.0.1 (first release)
          if [ "$MAJOR" = "0" ] && [ "$MINOR" = "0" ] && [ "$PATCH" = "1" ]; then
            MINOR=1
            PATCH=0
          fi

          NEXT="$MAJOR.$MINOR.$PATCH"
          echo "version=$NEXT" >> $GITHUB_OUTPUT
          echo "tag=v$NEXT" >> $GITHUB_OUTPUT
          echo "Bumping $LATEST_TAG -> v$NEXT (${{ steps.bump.outputs.type }})"

      - name: Update Cargo.toml version
        if: steps.bump.outputs.type != 'none'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^version = \".*\"/version = \"$VERSION\"/" Cargo.toml
          echo "Updated workspace version to $VERSION"

      - name: Commit and tag
        if: steps.bump.outputs.type != 'none'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml Cargo.lock
          git commit -m "release: ${{ steps.version.outputs.tag }}" || echo "No changes to commit"
          git tag "${{ steps.version.outputs.tag }}"
          git push origin main --tags
